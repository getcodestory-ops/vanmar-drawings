<!DOCTYPE html>
<html>

<head>
    <title>AUTOMATION CONTROL CENTER - VanMar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 0;
        }

        /* HEADER */
        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            height: 100px;
            width: auto;
            /* filter: brightness(0) invert(1); Makes logo white */
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: #e0e0e0;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .rate-limit-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            background: #2a2a2a;
            border-radius: 4px;
            border: 1px solid #3a3a3a;
        }

        .rate-limit-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
        }

        .rate-limit-dot.warning {
            background: #f39c12;
        }

        .rate-limit-dot.critical {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        .rate-limit-text {
            color: #e0e0e0;
        }

        .rate-limit-waiting {
            color: #f39c12;
            font-weight: 600;
        }


        /* MAIN LAYOUT */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        /* JOB MANAGER - LEFT COLUMN */
        .job-manager {
            grid-column: 1;
            grid-row: 1 / 3;
        }

        select,
        input[type="time"] {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            margin-top: 8px;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #27ae60;
        }

        select option {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .label {
            font-weight: 600;
            margin-top: 20px;
            display: block;
            color: #b0b0b0;
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
        }

        .btn-large {
            padding: 15px;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btn-spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        .btn.btn-secondary .btn-loading-spinner { border-top-color: #e0e0e0; border-color: rgba(255,255,255,0.2); }
        @keyframes btn-spin { to { transform: rotate(360deg); } }

        #discipline-select {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            min-height: 150px;
        }

        #discipline-select option:checked,
        #discipline-select option[selected] {
            background: #4CAF50 !important;
            color: #fff !important;
            font-weight: 600;
        }

        #drawing-select {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            min-height: 200px;
        }

        #drawing-select option:checked,
        #drawing-select option[selected] {
            background: #4CAF50 !important;
            color: #fff !important;
            font-weight: 600;
        }

        #queue-list {
            list-style: none;
            margin-top: 15px;
        }

        #queue-list li {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3a3a3a;
        }

        .remove-link {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .remove-link:hover {
            background: #3a1a1a;
        }

        #schedule-options {
            background: #252525;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #3a3a3a;
            display: none;
        }

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ACTIVE AUTOMATIONS - TOP RIGHT */
        .automations-panel {
            grid-column: 2;
            grid-row: 1;
            display: flex;
            flex-direction: column;
            max-height: 350px;
        }

        #schedule-list {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        .automation-card {
            background: #252525;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            position: relative;
        }

        .automation-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .automation-time {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            flex: 1;
        }

        .automation-delete-btn {
            color: #ff5441;
            cursor: pointer;
            font-size: 14px;
            color: white;
            padding: 5px;
            border-radius: 4px;
            border: none;
            background: #ff5441;
            line-height: 1;
            transition: all 0.2s;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .automation-delete-btn:hover {
            background: #ffebee;
            transform: scale(1.05);
        }

        .countdown {
            margin-top: 6px;
            font-size: 11px;
            color: #888;
        }

        .countdown-bar {
            width: 100%;
            height: 6px;
            background: #2a2a2a;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .countdown-fill {
            height: 100%;
            background: #f39c12;
            transition: width 1s;
        }


        /* METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: #252525;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 15px;
        }

        .metric-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-trend {
            font-size: 11px;
            color: #27ae60;
            margin-top: 5px;
        }


        /* JOB HISTORY */
        .history-panel {
            grid-column: 1 / 3;
            grid-row: 3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #252525;
            color: #b0b0b0;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 1px solid #3a3a3a;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #2a2a2a;
            font-size: 13px;
        }

        .progress-container {
            width: 100%;
            background: #2a2a2a;
            border-radius: 4px;
            height: 8px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #27ae60;
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 11px;
            color: #b0b0b0;
            font-weight: 600;
        }

        .download-btn {
            background: #27ae60;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .download-btn:hover {
            background: #229954;
        }

        .download-btn.disabled {
            background: #95a5a6;
            color: #ecf0f1;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        .cancel-btn {
            background: #ff5441 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            transition: background 0.2s;
        }

        .cancel-btn:hover {
            background: #c0392b !important;
        }

        .delete-btn {
            background: #ff5441 !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            transition: background 0.2s;
            margin-left: 8px;
        }

        .delete-btn:hover {
            background: #c0392b !important;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-footer {
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* FOOTER */
        .footer {
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            padding: 20px 30px;
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: #888;
            text-decoration: none;
        }

        .footer-links a:hover {
            color: #27ae60;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 18px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .job-manager {
                grid-row: 1;
            }
            .automations-panel {
                grid-column: 1;
                grid-row: 2;
            }
            .history-panel {
                grid-column: 1;
                grid-row: 4;
            }
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <img src="/static/vanmar-logo.png" alt="VanMar Constructors Inc." class="logo-img">
        </div>
        <div class="header-right">
            <div class="header-title">DRAWINGS MERGER APPLICATION</div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span style="font-size: 10px;">OPERATIONAL</span>
            </div>
            <div id="rate-limit-indicator" class="rate-limit-indicator" style="display: none;">
                <div id="rate-limit-dot" class="rate-limit-dot"></div>
                <span id="rate-limit-text" class="rate-limit-text">Loading...</span>
            </div>
            <div>
                <span style="font-size: 10px; color: #888;">Version 1.1.6</span>
            </div>
            <div id="dev-mode-indicator" style="display: none; margin-left: 15px; padding: 4px 8px; background: #f39c12; color: #000; border-radius: 4px; font-size: 10px; font-weight: bold;">
                DEV MODE
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-dashboard" class="main-container">
        <!-- JOB MANAGER -->
        <div class="panel job-manager">
            <div class="panel-title">üöÄ JOB MANAGER</div>
            
            
            <label class="label">1. BUILD YOUR QUEUE</label>
        <select id="project-select" onchange="loadDisciplines()">
                <option value="">-- Select Project --</option>
        </select>
            
        <div id="discipline-section" style="display:none;">
            <label class="label">Select Disciplines <span id="discipline-count" style="color: #888; font-size: 11px; font-weight: normal;">(0 displayed, 0 selected)</span></label>
                <div class="btn-group">
                    <button id="select-all-disciplines-btn" class="btn btn-secondary" onclick="selectAllDisciplines()" disabled>Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDisciplines()">Deselect All</button>
        </div>
            <select id="discipline-select" multiple size="6" onchange="updateDisciplineCount(); loadDrawings();"></select>
            
            <div id="drawings-section" style="display:none; margin-top: 15px;">
                <label class="label">Select Drawings (or leave empty for all) <span id="drawing-count" style="color: #888; font-size: 11px; font-weight: normal;">(0 displayed, 0 selected)</span></label>
                <div class="btn-group">
                    <button id="select-all-drawings-btn" class="btn btn-secondary" onclick="selectAllDrawings()" disabled>Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDrawings()">Deselect All</button>
                </div>
                <select id="drawing-select" multiple size="8" onchange="updateDrawingCount();"></select>
            </div>
            
            <button id="add-to-queue-dev-btn" class="btn btn-primary" onclick="addToQueue()" style="margin-top: 15px;">‚¨áÔ∏è Add to Queue</button>
        </div>
        
        <div id="simple-mode-actions" style="display:none; margin-top: 15px; gap: 10px;">
            <button id="add-to-queue-simple-btn" class="btn btn-primary" onclick="runProjectDirectly()" style="flex: 1;">‚ñ∫ Run Now</button>
            <button id="schedule-simple-btn" class="btn btn-secondary" onclick="scheduleProjectDirectly()" style="flex: 1;">üìÖ Schedule</button>
        </div>
        
        <!-- Schedule options for direct scheduling in simple mode (outside queue section) -->
        <div id="schedule-options-simple" style="margin-top: 20px; display:none;">
            <label class="label">üìÖ Schedule Automation</label>
            <p id="tz-display-simple" style="font-size:11px; color:#888; margin-bottom:10px;"></p>
            <div style="display:flex; gap:10px;">
                <select id="sched-day-simple">
                    <option value="Mon">Monday</option>
                    <option value="Tue">Tuesday</option>
                    <option value="Wed">Wednesday</option>
                    <option value="Thu">Thursday</option>
                    <option value="Fri" selected>Friday</option>
                    <option value="Sat">Saturday</option>
                    <option value="Sun">Sunday</option>
                </select>
                <input type="time" id="sched-time-simple" value="17:30">
            </div>
            <button class="btn btn-primary btn-large" onclick="confirmScheduleSimple()" style="margin-top: 10px;">‚úÖ Save Automation</button>
            <button class="btn btn-secondary" onclick="cancelScheduleSimple()" style="margin-top: 10px; margin-left: 10px;">Cancel</button>
        </div>
        
            
            <div id="queue-section" style="margin-top: 20px; display:none;">
                <label class="label">2. CURRENT QUEUE</label>
            <ul id="queue-list"></ul>
                
            <div id="schedule-options">
                    <h3 style="margin-bottom: 10px; font-size: 14px;">üìÖ Automation Settings</h3>
                    <p id="tz-display" style="font-size:11px; color:#888; margin-bottom:10px;"></p>
                <div style="display:flex; gap:10px;">
                    <select id="sched-day">
                        <option value="Mon">Monday</option>
                            <option value="Tue">Tuesday</option>
                            <option value="Wed">Wednesday</option>
                            <option value="Thu">Thursday</option>
                        <option value="Fri" selected>Friday</option>
                            <option value="Sat">Saturday</option>
                            <option value="Sun">Sunday</option>
                    </select>
                    <input type="time" id="sched-time" value="17:30">
                </div>
                    <button class="btn btn-primary btn-large" onclick="confirmSchedule()">‚úÖ Save Automation</button>
            </div>
                
            <div class="action-row" id="main-actions">
                    <button class="btn btn-primary" style="flex: 1;" onclick="executeBatch()">‚ñ∫ Run Now</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="showScheduleOpts()">üìÖ Schedule</button>
            </div>
        </div>
    </div>

        <!-- ACTIVE AUTOMATIONS -->
        <div class="panel automations-panel">
            <div class="panel-title">
                üóìÔ∏è ACTIVE AUTOMATIONS
                <span id="automation-count" style="font-size: 12px; color: #888; font-weight: normal; margin-left: 8px;">(0)</span>
                <span class="live-indicator">
                    <span class="live-dot"></span>
                    <span style="font-size: 11px; color: #e74c3c;">‚Ä¢ LIVE</span>
                </span>
    </div>
            <div id="schedule-list">
                <div style="color:#666; text-align:center; padding:20px;">Loading...</div>
            </div>
        </div>



        <!-- RECENT JOB HISTORY -->
        <div class="panel history-panel">
            <div class="panel-title">üïí RECENT JOB HISTORY</div>
        <table>
            <thead>
                <tr>
                        <th>TIME</th>
                        <th>PROJECT</th>
                        <th>PROGRESS</th>
                        <th>RUNTIME</th>
                        <th>RESULT</th>
                </tr>
            </thead>
            <tbody id="jobs-table-body"></tbody>
        </table>
            <div class="history-footer">
                <span id="history-count">SHOWING 0 OF 0 RECORDS</span>
                <div id="history-pagination" style="display: none; margin-top: 10px; justify-content: space-between; align-items: center; gap: 10px;">
                    <button id="history-prev-btn" onclick="changeHistoryPage(-1)" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;" disabled>‚Üê Previous</button>
                    <span id="history-page-info" style="color: #888; font-size: 12px;">Page 1 of 1</span>
                    <button id="history-next-btn" onclick="changeHistoryPage(1)" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;" disabled>Next ‚Üí</button>
    </div>
    </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div>INTERNAL USE ONLY ¬© 2024 VANMAR CONSTRUCTORS INC.</div>
    </div>

    <script>
        // Mode detection: Simple mode (default) or Developer mode (?mode=dev)
        const isDeveloperMode = new URLSearchParams(window.location.search).get('mode') === 'dev';
        
        // Show developer mode indicator if in dev mode
        if (isDeveloperMode) {
            document.getElementById('dev-mode-indicator').style.display = 'block';
        }
        
        let jobQueue = [];
        let directScheduleProject = null; // Store project for direct scheduling in simple mode
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let isRedirecting = false;
        let currentHistoryPage = 1;

        // Helper function to fetch all disciplines for a project (used in simple mode)
        async function fetchAllDisciplinesForProject(projectId) {
            try {
                const response = await authenticatedFetch(`/api/disciplines?project_id=${projectId}`);
                if (!response.ok) {
                    throw new Error('Failed to load disciplines');
                }
                const data = await response.json();
                if (data.disciplines && data.disciplines.length > 0) {
                    // Handle both formats: [{name, count}] or [string]
                    return data.disciplines.map(d => typeof d === 'object' ? (d.name || d) : d);
                }
                return [];
            } catch (error) {
                console.error('Error fetching all disciplines:', error);
                return [];
            }
        }

        // Centralized fetch wrapper that handles authentication failures
        function authenticatedFetch(url, options = {}) {
            return fetch(url, options)
                .then(response => {
                    // Check for authentication failures
                    if (response.status === 401 || response.status === 403) {
                        if (!isRedirecting) {
                            isRedirecting = true;
                            
                            // Show visual notification overlay
                            const overlay = document.createElement('div');
                            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-size:18px;';
                            overlay.innerHTML = `
                                <div style="text-align:center;padding:30px;background:#1a1a1a;border-radius:8px;border:2px solid #e74c3c;">
                                    <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
                                    <div style="font-weight:600;margin-bottom:10px;">Procore Connection Lost</div>
                                    <div style="font-size:14px;color:#888;">Redirecting to login page...</div>
                                </div>
                            `;
                            document.body.appendChild(overlay);
                            
                            // Redirect after showing message
                            setTimeout(() => {
                                window.location.href = "/login";
                            }, 2000);
                        }
                        // Return a rejected promise to stop further processing
                        return Promise.reject(new Error('Authentication failed'));
                    }
                    return response;
                })
                .catch(error => {
                    // If it's an auth error, don't log it (we're redirecting)
                    if (error.message === 'Authentication failed') {
                        throw error;
                    }
                    // For other errors, log and rethrow
                    console.error('Fetch error:', error);
                    throw error;
                });
        }

        // Initialize
        authenticatedFetch('/api/projects')
            .then(r => r.json())
            .then(data => {
                const sel = document.getElementById('project-select');
                sel.innerHTML = '<option value="">-- Select Project --</option>';
                if (data) data.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            })
            .catch(error => {
                if (error.message !== 'Authentication failed') {
                    console.error('Error loading projects:', error);
                }
            });

        // Initialize: always start on page 1 to show most recent jobs
        currentHistoryPage = 1;
        loadRecentJobs(); 
        loadSchedules();
        
        // Update rate limit status immediately and then every 5 seconds
        updateRateLimitStatus();
        setInterval(updateRateLimitStatus, 5000);
        
        setInterval(() => {
            // Always check current page for jobs
            loadRecentJobs();
        }, 2000);
        
        // Update running job times every second
        setInterval(() => {
            const tbody = document.getElementById('jobs-table-body');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const runtimeEl = row.querySelector('[id^="runtime-"]');
                if (runtimeEl) {
                    const createdAt = runtimeEl.getAttribute('data-created-at');
                    if (createdAt) {
                        const elapsed = calculateElapsedTime(createdAt);
                        runtimeEl.innerHTML = `‚è±Ô∏è ${elapsed}`;
                    }
                }
            });
        }, 1000);


        function updateHistoryCount() {
            authenticatedFetch(`/api/recent_jobs?page=${currentHistoryPage}&per_page=6`)
                .then(r => r.json())
                .then(data => {
                    const jobs = data.jobs || [];
                    const pagination = data.pagination || {};
                    const total = pagination.total || 0;
                    const showing = jobs.length;
                    const start = showing > 0 ? (currentHistoryPage - 1) * 6 + 1 : 0;
                    const end = start + showing - 1;
                    
                    document.getElementById('history-count').textContent = `SHOWING ${showing} OF ${total} RECORDS`;
                    
                    // Update pagination controls
                    const paginationEl = document.getElementById('history-pagination');
                    const pageInfo = document.getElementById('history-page-info');
                    const prevBtn = document.getElementById('history-prev-btn');
                    const nextBtn = document.getElementById('history-next-btn');
                    
                    if (total > 6) {
                        paginationEl.style.display = 'flex';
                        pageInfo.textContent = `Page ${pagination.page || 1} of ${pagination.total_pages || 1}`;
                        prevBtn.disabled = !pagination.has_prev;
                        nextBtn.disabled = !pagination.has_next;
                    } else {
                        paginationEl.style.display = 'none';
                    }
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error updating history count:', error);
                    }
                });
        }
        
        function changeHistoryPage(delta) {
            const newPage = currentHistoryPage + delta;
            if (newPage < 1) return;
            
            currentHistoryPage = newPage;
            loadRecentJobs();
            updateHistoryCount();
        }
        
        function calculateElapsedTime(createdAt) {
            const start = new Date(createdAt + "Z");
            const now = new Date();
            const seconds = Math.floor((now - start) / 1000);
            return formatRuntime(seconds);
        }
        
        function formatRuntime(totalSeconds) {
            if (totalSeconds < 60) {
                return `${totalSeconds}s`;
            } else if (totalSeconds < 3600) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return seconds > 0 ? `${minutes}m ${seconds}s` : `${minutes}m`;
            } else {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (minutes > 0 && seconds > 0) {
                    return `${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${hours}h ${seconds}s`;
                }
            }
        }
        

        function updateDisciplineCount() {
            const sel = document.getElementById('discipline-select');
            const countEl = document.getElementById('discipline-count');
            if (!sel || !countEl) return;
            
            const total = Array.from(sel.options).filter(opt => !opt.disabled).length;
            const selected = Array.from(sel.selectedOptions).length;
            countEl.textContent = `(${total} displayed, ${selected} selected)`;
        }

        function selectAllDisciplines() {
            const sel = document.getElementById('discipline-select');
            if (!sel || sel.disabled) return;
            
            // Select all non-disabled options
            Array.from(sel.options).forEach(opt => {
                if (!opt.disabled && opt.value !== '') {
                    opt.selected = true;
                }
            });
            
            // Force browser to repaint by focusing and blurring
            sel.focus();
            setTimeout(() => {
                sel.blur();
                // Trigger change event to update counts and load drawings
                sel.dispatchEvent(new Event('change'));
            }, 10);
        }

        function deselectAllDisciplines() {
            const sel = document.getElementById('discipline-select');
            if (!sel || sel.disabled) return;
            
            Array.from(sel.options).forEach(opt => opt.selected = false);
            
            // Trigger change event to update counts
            sel.dispatchEvent(new Event('change'));
        }

        function loadDisciplines() {
            const pid = document.getElementById('project-select').value;
            const selectAllBtn = document.getElementById('select-all-disciplines-btn');
            if (!pid) {
                document.getElementById('discipline-section').style.display = 'none';
                document.getElementById('drawings-section').style.display = 'none';
                document.getElementById('simple-mode-actions').style.display = 'none';
                if (selectAllBtn) selectAllBtn.disabled = true;
                return;
            }
            
            // Simple mode: Hide discipline/drawing sections, show action buttons
            if (!isDeveloperMode) {
                document.getElementById('discipline-section').style.display = 'none';
                document.getElementById('drawings-section').style.display = 'none';
                const simpleActions = document.getElementById('simple-mode-actions');
                simpleActions.style.display = 'flex';
                simpleActions.style.flexDirection = 'row';
                document.getElementById('add-to-queue-dev-btn').style.display = 'none';
                // In simple mode, disciplines will be auto-fetched when adding to queue or scheduling
                return;
            }
            
            // Developer mode: Hide simple mode buttons
            document.getElementById('simple-mode-actions').style.display = 'none';
            document.getElementById('add-to-queue-dev-btn').style.display = 'block';
            
            // Developer mode: Show discipline section and load disciplines
            document.getElementById('discipline-section').style.display = 'block';
            document.getElementById('drawings-section').style.display = 'none';
            const sel = document.getElementById('discipline-select');
            sel.innerHTML = '<option disabled style="color: #666; text-align: center;">‚è≥ Loading disciplines...</option>';
            sel.disabled = true;
            if (selectAllBtn) selectAllBtn.disabled = true;
            
            authenticatedFetch(`/api/disciplines?project_id=${pid}`)
                .then(r => {
                    if (!r.ok) throw new Error('Failed to load disciplines');
                    return r.json();
                })
                .then(data => {
                    sel.disabled = false;
                sel.innerHTML = '';
                    if (data.disciplines && data.disciplines.length > 0) {
                        // Check if disciplines is array of objects (with counts) or strings (legacy)
                        const isObjectFormat = typeof data.disciplines[0] === 'object';
                        if (isObjectFormat) {
                            data.disciplines.forEach(d => {
                                const name = d.name || d;
                                const count = d.count || 0;
                                sel.innerHTML += `<option value="${name}">${name} (${count} drawing${count !== 1 ? 's' : ''})</option>`;
                            });
                            const totalDrawings = data.disciplines.reduce((sum, d) => sum + (d.count || 0), 0);
                        } else {
                            // Legacy format - just strings
                            data.disciplines.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
                        }
                        updateDisciplineCount();
                        // Enable Select All button now that disciplines are loaded
                        const selectAllBtn = document.getElementById('select-all-disciplines-btn');
                        if (selectAllBtn) selectAllBtn.disabled = false;
                    } else {
                        sel.innerHTML = '<option disabled style="color: #666;">No disciplines found</option>';
                        updateDisciplineCount();
                        // Keep button disabled if no disciplines found
                        const selectAllBtn = document.getElementById('select-all-disciplines-btn');
                        if (selectAllBtn) selectAllBtn.disabled = true;
                    }
                })
                .catch(error => {
                    if (error.message === 'Authentication failed') {
                        return; // Don't show error, redirecting
                    }
                    sel.disabled = false;
                    sel.innerHTML = '<option disabled style="color: #e74c3c;">‚ùå Error loading disciplines</option>';
                    // Keep button disabled on error
                    const selectAllBtn = document.getElementById('select-all-disciplines-btn');
                    if (selectAllBtn) selectAllBtn.disabled = true;
                });
        }

        function loadDrawings() {
            const pid = document.getElementById('project-select').value;
            const dSel = document.getElementById('discipline-select');
            const selectedDisciplines = Array.from(dSel.selectedOptions).map(o => o.value);
            
            if (!pid || selectedDisciplines.length === 0) {
                document.getElementById('drawings-section').style.display = 'none';
                // Disable Select All button when drawings section is hidden
                const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
                if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = true;
                return;
            }
            
            // Show drawings section
            document.getElementById('drawings-section').style.display = 'block';
            const drawingSel = document.getElementById('drawing-select');
            const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
            drawingSel.innerHTML = '<option disabled style="color: #666;">‚è≥ Loading drawings...</option>';
            drawingSel.disabled = true;
            if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = true;
            
            // Load drawings for all selected disciplines
            const allDrawings = [];
            const loadPromises = selectedDisciplines.map(discipline => 
                authenticatedFetch(`/api/drawings?project_id=${pid}&discipline=${encodeURIComponent(discipline)}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`Failed to load drawings for ${discipline}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data.drawings) {
                            data.drawings.forEach(d => {
                                d.discipline = discipline; // Tag with discipline
                                allDrawings.push(d);
                            });
                        }
                    })
            );
            
            Promise.all(loadPromises)
                .then(() => {
                    drawingSel.disabled = false;
                    drawingSel.innerHTML = '';
                    
                    if (allDrawings.length > 0) {
                        // Sort by drawing number
                        allDrawings.sort((a, b) => {
                            const numA = a.number || '';
                            const numB = b.number || '';
                            return numA.localeCompare(numB, undefined, { numeric: true, sensitivity: 'base' });
                        });
                        
                        // Populate main drawing select
                        allDrawings.forEach(d => {
                            const rev = d.revision ? ` Rev.${d.revision}` : '';
                            const optionText = `${d.number}${rev} - ${d.title || ''} (${d.discipline})`;
                            drawingSel.innerHTML += `<option value="${d.id}" data-number="${d.number}" data-discipline="${d.discipline}">${optionText}</option>`;
                        });
                        
                        updateDrawingCount();
                        // Enable Select All button now that drawings are loaded
                        const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
                        if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = false;
                    } else {
                        drawingSel.innerHTML = '<option disabled style="color: #666;">No drawings found</option>';
                        updateDrawingCount();
                        // Keep button disabled if no drawings found
                        const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
                        if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = true;
                    }
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        drawingSel.disabled = false;
                        drawingSel.innerHTML = '<option disabled style="color: #e74c3c;">‚ùå Error loading drawings</option>';
                        updateDrawingCount();
                        // Keep button disabled on error
                        const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
                        if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = true;
                    }
                });
        }

        function updateDrawingCount() {
            const sel = document.getElementById('drawing-select');
            const countEl = document.getElementById('drawing-count');
            if (!sel || !countEl) return;
            
            const total = Array.from(sel.options).filter(opt => !opt.disabled).length;
            const selected = Array.from(sel.selectedOptions).length;
            countEl.textContent = `(${total} displayed, ${selected} selected)`;
        }

        function selectAllDrawings() {
            const sel = document.getElementById('drawing-select');
            if (!sel || sel.disabled) return;
            
            // Select all non-disabled options
            Array.from(sel.options).forEach(opt => {
                if (!opt.disabled && opt.value !== '') {
                    opt.selected = true;
                }
            });
            
            // Force browser to repaint by focusing and blurring
            sel.focus();
            setTimeout(() => {
                sel.blur();
                // Trigger change event to update counts
                sel.dispatchEvent(new Event('change'));
            }, 10);
        }

        function deselectAllDrawings() {
            const sel = document.getElementById('drawing-select');
            if (!sel || sel.disabled) return;
            
            Array.from(sel.options).forEach(opt => opt.selected = false);
            
            // Trigger change event to update counts
            sel.dispatchEvent(new Event('change'));
        }

        function addToQueue() {
            const pSel = document.getElementById('project-select');
            const projectId = parseInt(pSel.value);
            const projectName = pSel.options[pSel.selectedIndex].text;
            
            if (!projectId) {
                return;
            }
            
            // Simple mode: Auto-fetch all disciplines
            if (!isDeveloperMode) {
                const addBtn = document.getElementById('add-to-queue-simple-btn');
                const scheduleBtn = document.getElementById('schedule-simple-btn');
                const originalAddHtml = addBtn.innerHTML;
                addBtn.disabled = true;
                scheduleBtn.disabled = true;
                addBtn.innerHTML = '<span class="btn-loading-spinner"></span> Loading...';
                
                fetchAllDisciplinesForProject(projectId).then(discs => {
                    try {
                        if (discs.length === 0) {
                            alert('No disciplines found for this project.');
                            return;
                        }
                        
                        const jobData = { 
                            project_id: projectId, 
                            project_name: projectName, 
                            disciplines: discs
                        };
                        
                        jobQueue.push(jobData);
                        renderQueue();
                        pSel.value = "";
                        document.getElementById('simple-mode-actions').style.display = 'none';
                    } finally {
                        addBtn.disabled = false;
                        scheduleBtn.disabled = false;
                        addBtn.innerHTML = originalAddHtml;
                    }
                });
                return;
            }
            
            // Developer mode: Require discipline selection
            const dSel = document.getElementById('discipline-select');
            const drawingSel = document.getElementById('drawing-select');
            const discs = Array.from(dSel.selectedOptions).map(o => o.value);
            const selectedDrawings = Array.from(drawingSel.selectedOptions).map(o => o.value);
            
            if (discs.length === 0) {
                return;
            }
            
            const jobData = { 
                project_id: projectId, 
                project_name: projectName, 
                disciplines: discs
            };
            
            // If specific drawings are selected, include them; otherwise process all drawings in disciplines
            if (selectedDrawings.length > 0) {
                jobData.drawing_ids = selectedDrawings.map(id => parseInt(id)); // Convert to integers
            }
            
            jobQueue.push(jobData);
            renderQueue();
            pSel.value = ""; 
            dSel.innerHTML = ""; 
            drawingSel.innerHTML = "";
            document.getElementById('discipline-section').style.display = 'none';
            document.getElementById('drawings-section').style.display = 'none';
            document.getElementById('add-to-queue-simple-btn').style.display = 'none';
            // Disable Select All buttons when sections are hidden
            const selectAllDisciplinesBtn = document.getElementById('select-all-disciplines-btn');
            const selectAllDrawingsBtn = document.getElementById('select-all-drawings-btn');
            if (selectAllDisciplinesBtn) selectAllDisciplinesBtn.disabled = true;
            if (selectAllDrawingsBtn) selectAllDrawingsBtn.disabled = true;
        }

        function renderQueue() {
            const list = document.getElementById('queue-list');
            const queueSection = document.getElementById('queue-section');
            // In simple mode, never show the queue section
            if (!isDeveloperMode) {
                queueSection.style.display = 'none';
                return;
            }
            // Developer mode: show queue section when there are items
            queueSection.style.display = jobQueue.length ? 'block' : 'none';
            list.innerHTML = '';
            jobQueue.forEach((j, i) => {
                const li = document.createElement('li');
                let desc = `<b>${j.project_name}</b> - ${j.disciplines.join(', ')}`;
                if (j.drawing_ids && j.drawing_ids.length > 0) {
                    desc += ` (${j.drawing_ids.length} selected drawing${j.drawing_ids.length !== 1 ? 's' : ''})`;
                }
                li.innerHTML = `<span>${desc}</span> <span class="remove-link" onclick="jobQueue.splice(${i},1);renderQueue()">DELETE</span>`;
                list.appendChild(li);
            });
        }

        // Run a project directly in simple mode (without adding to queue first)
        async function runProjectDirectly() {
            const pSel = document.getElementById('project-select');
            const projectId = parseInt(pSel.value);
            const projectName = pSel.options[pSel.selectedIndex].text;
            
            if (!projectId) {
                return;
            }
            
            const runBtn = document.getElementById('add-to-queue-simple-btn');
            const scheduleBtn = document.getElementById('schedule-simple-btn');
            const originalRunHtml = runBtn.innerHTML;
            
            // Show loading state immediately to prevent double-clicks
            runBtn.disabled = true;
            scheduleBtn.disabled = true;
            runBtn.innerHTML = '<span class="btn-loading-spinner"></span> Loading...';
            
            try {
                // Auto-fetch all disciplines
                const discs = await fetchAllDisciplinesForProject(projectId);
                if (discs.length === 0) {
                    alert('No disciplines found for this project.');
                    return;
                }
                
                // Create job data and run immediately
                const jobData = { 
                    project_id: projectId, 
                    project_name: projectName, 
                    disciplines: discs
                };
                
                // Run the job directly
                authenticatedFetch('/api/start_job', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ queue: [jobData] }) 
                })
                .then(r => r.json())
                .then(() => { 
                    // Reset UI
                    pSel.value = "";
                    document.getElementById('simple-mode-actions').style.display = 'none';
                })
                .catch(err => {
                    console.error('Error starting job:', err);
                });
            } finally {
                // Restore buttons if we didn't navigate away (e.g. on error)
                runBtn.disabled = false;
                scheduleBtn.disabled = false;
                runBtn.innerHTML = originalRunHtml;
            }
        }

        function executeBatch() {
            if (jobQueue.length === 0) {
                return;
            }
            authenticatedFetch('/api/start_job', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ queue: jobQueue }) 
            })
            .then(r => r.json())
            .then(() => { 
                jobQueue = []; 
                renderQueue(); 
            })
            .catch(err => {
                // Error handling
            });
        }

        // Schedule a project directly in simple mode (without adding to queue first)
        async function scheduleProjectDirectly() {
            const pSel = document.getElementById('project-select');
            const projectId = parseInt(pSel.value);
            const projectName = pSel.options[pSel.selectedIndex].text;
            
            if (!projectId) {
                return;
            }
            
            const scheduleBtn = document.getElementById('schedule-simple-btn');
            const addBtn = document.getElementById('add-to-queue-simple-btn');
            const originalScheduleHtml = scheduleBtn.innerHTML;
            
            // Show loading state immediately to prevent double-clicks
            scheduleBtn.disabled = true;
            addBtn.disabled = true;
            scheduleBtn.innerHTML = '<span class="btn-loading-spinner"></span> Loading...';
            
            try {
                // Auto-fetch all disciplines
                const discs = await fetchAllDisciplinesForProject(projectId);
                if (discs.length === 0) {
                    alert('No disciplines found for this project.');
                    return;
                }
                
                // Store project data for scheduling (don't add to visible queue)
                directScheduleProject = { 
                    project_id: projectId, 
                    project_name: projectName, 
                    disciplines: discs
                };
                
                // Hide simple mode actions and show schedule options directly
                document.getElementById('simple-mode-actions').style.display = 'none';
                document.getElementById('schedule-options-simple').style.display = 'block';
                document.getElementById('tz-display-simple').innerText = `Detected Timezone: ${userTimezone}`;
                
                // Scroll to schedule options
                document.getElementById('schedule-options-simple').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } finally {
                // Restore buttons if we didn't navigate away (e.g. on error)
                scheduleBtn.disabled = false;
                addBtn.disabled = false;
                scheduleBtn.innerHTML = originalScheduleHtml;
            }
        }
        
        function cancelScheduleSimple() {
            directScheduleProject = null;
            document.getElementById('schedule-options-simple').style.display = 'none';
            document.getElementById('project-select').value = '';
        }
        
        function confirmScheduleSimple() {
            const day = document.getElementById('sched-day-simple').value;
            const time = document.getElementById('sched-time-simple').value;
            
            if (!directScheduleProject) {
                alert('No project selected for scheduling.');
                return;
            }
            
            authenticatedFetch('/api/schedule_batch', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queue: [directScheduleProject], day: day, time: time, timezone: userTimezone })
            })
            .then(r => r.json())
            .then(() => {
                // Clear stored project
                directScheduleProject = null;
                document.getElementById('schedule-options-simple').style.display = 'none';
                document.getElementById('project-select').value = '';
                loadSchedules();
            })
            .catch(err => {
                // Error handling
                console.error('Error scheduling:', err);
            });
        }

        function showScheduleOpts() {
            if (jobQueue.length === 0) {
                return;
            }
            document.getElementById('schedule-options').style.display = 'block';
            document.getElementById('main-actions').style.display = 'none';
            document.getElementById('tz-display').innerText = `Detected Timezone: ${userTimezone}`;
        }

        function confirmSchedule() {
            const day = document.getElementById('sched-day').value;
            const time = document.getElementById('sched-time').value;
            
            // In simple mode direct scheduling, use stored project instead of jobQueue
            const queueToSchedule = directScheduleProject ? [directScheduleProject] : jobQueue;
            
            if (queueToSchedule.length === 0) {
                alert('No project selected for scheduling.');
                return;
            }
            
            authenticatedFetch('/api/schedule_batch', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queue: queueToSchedule, day: day, time: time, timezone: userTimezone })
            })
            .then(r => r.json())
            .then(() => {
                // Clear stored project and queue
                directScheduleProject = null;
                jobQueue = []; 
                renderQueue(); 
                document.getElementById('schedule-options').style.display = 'none'; 
                document.getElementById('main-actions').style.display = 'flex'; 
                
                // Reset project select and hide simple mode actions
                document.getElementById('project-select').value = '';
                document.getElementById('simple-mode-actions').style.display = 'none';
                
                loadSchedules();
            })
            .catch(err => {
                // Error handling
            });
        }

        function loadSchedules() {
            authenticatedFetch('/api/schedules')
                .then(r => r.json())
                .then(data => {
                const list = document.getElementById('schedule-list');
                const countEl = document.getElementById('automation-count');
                list.innerHTML = '';
                    
                    // Update count display
                    const count = data.length || 0;
                    if (countEl) {
                        countEl.textContent = `(${count})`;
                    }
                    
                    if (!data.length) {
                        list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No active schedules.</div>';
                        return;
                    }
                data.forEach(s => {
                    const discs = JSON.parse(s.disciplines_json);
                    const timeStr = `${s.day_of_week} ${s.hour.toString().padStart(2, '0')}:${s.minute.toString().padStart(2, '0')}`;
                    const card = document.createElement('div');
                    card.className = 'automation-card';
                    
                    // Calculate next run time
                    const now = new Date();
                    const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const nextRun = calculateNextRun(s.day_of_week, s.hour, s.minute, s.timezone);
                    const timeUntil = getTimeUntil(nextRun);
                    
                    card.innerHTML = `
                        <div class="automation-card-header">
                            <div class="automation-time">
                                <span>üïê</span>
                                <span><b>${timeStr}</b> (${s.timezone})</span>
                            </div>
                            <button class="automation-delete-btn" onclick="deleteSchedule('${s.id}')" title="Delete automation">X</button>
                        </div>
                        <div style="margin-bottom: 6px; font-size: 12px;">Project: <b>${s.project_name}</b></div>
                        <div class="countdown">
                            NEXT RUN IN: <span id="countdown-${s.id}">${timeUntil}</span> <span style="font-size: 10px; color: #666;">(DD:HH:MM:SS)</span>
                            <div class="countdown-bar">
                                <div class="countdown-fill" id="bar-${s.id}" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                    
                    // Update countdown
                    updateCountdown(s.id, nextRun);
                });
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error loading schedules:', error);
                    }
                });
        }

        function calculateNextRun(dayOfWeek, hour, minute, timezone) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const currentDay = days[today.getDay() === 0 ? 6 : today.getDay() - 1];
            const targetDayIndex = days.indexOf(dayOfWeek);
            const currentDayIndex = days.indexOf(currentDay);
            
            let daysUntil = targetDayIndex - currentDayIndex;
            if (daysUntil < 0) daysUntil += 7;
            if (daysUntil === 0) {
                const now = new Date();
                const targetTime = new Date(now);
                targetTime.setHours(hour, minute, 0, 0);
                if (targetTime <= now) daysUntil = 7;
            }
            
            const nextRun = new Date();
            nextRun.setDate(nextRun.getDate() + daysUntil);
            nextRun.setHours(hour, minute, 0, 0);
            return nextRun;
        }

        function getTimeUntil(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            if (diff < 0) return '00:00:00:00';
            const days = Math.floor(diff / (24 * 3600000));
            const hours = Math.floor((diff % (24 * 3600000)) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateCountdown(scheduleId, targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            const totalDay = 7 * 24 * 60 * 60 * 1000;
            const percent = Math.max(0, Math.min(100, 100 - (diff / totalDay * 100)));
            
            const countdownEl = document.getElementById(`countdown-${scheduleId}`);
            const barEl = document.getElementById(`bar-${scheduleId}`);
            if (countdownEl) countdownEl.textContent = getTimeUntil(targetDate);
            if (barEl) barEl.style.width = `${percent}%`;
        }

        setInterval(() => {
            authenticatedFetch('/api/schedules')
                .then(r => r.json())
                .then(data => {
                    data.forEach(s => {
                        const nextRun = calculateNextRun(s.day_of_week, s.hour, s.minute, s.timezone);
                        updateCountdown(s.id, nextRun);
                    });
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error updating countdown:', error);
                    }
                });
        }, 1000);

        function deleteSchedule(id) {
            if (confirm("Stop this automation?")) {
                authenticatedFetch(`/api/schedule/${id}`, { method: 'DELETE' })
                    .then(() => {
                        loadSchedules();
                    })
                    .catch(error => {
                        // Error handling
                    });
            }
        }

        function loadRecentJobs(forcePage = null, forceRefresh = false) {
            const pageToLoad = forcePage !== null ? forcePage : currentHistoryPage;
            const cacheBuster = forceRefresh ? `&_t=${new Date().getTime()}` : '';
            authenticatedFetch(`/api/recent_jobs?page=${pageToLoad}&per_page=6${cacheBuster}`, {
                cache: forceRefresh ? 'no-cache' : 'default'
            })
                .then(r => r.json())
                .then(data => {
                    const jobs = data.jobs || [];
                    const pagination = data.pagination || {};
                    
                    // Check if there are any active jobs (queued, processing, uploading) on page 1
                    // If user is on a different page and there are active jobs, suggest going to page 1
                    // But don't force it - let user navigate freely
                    const hasActiveJobsOnPage1 = pageToLoad === 1 && jobs.some(j => ['queued', 'processing', 'uploading'].includes(j.status));
                    
                    // Update current page if we forced a page change
                    if (forcePage !== null) {
                        currentHistoryPage = forcePage;
                    }
                    
                const tbody = document.getElementById('jobs-table-body');
                tbody.innerHTML = '';
                    
                    if (jobs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;padding:20px;">No jobs found</td></tr>';
                    }
                    
                jobs.forEach(j => {
                    let actionHtml = '-';
                    let pct = j.progress || 0;
                    let barColor = '#3498db';
                    let statusText = j.status.toUpperCase();

                    // Build progress text with drawing counts if available
                    let progressDetails = '';
                    if (j.total_drawings && j.total_drawings > 0) {
                        const processed = j.processed_drawings || 0;
                        const remaining = Math.max(0, j.total_drawings - processed);
                        progressDetails = ` (${processed}/${j.total_drawings} drawings)`;
                    }
                    
                    if (j.status === 'processing') { 
                        statusText = `GENERATING ${pct}%${progressDetails}`; 
                    } else if (j.status === 'uploading') { 
                        statusText = "UPLOADING..."; 
                        barColor = '#f39c12'; 
                    } else if (j.status === 'completed') { 
                        statusText = "SUCCESS"; 
                        barColor = '#27ae60'; 
                        pct = 100; 
                    } else if (j.status === 'failed') { 
                        statusText = "FAILED"; 
                        barColor = '#e74c3c'; 
                        pct = 100; 
                    } else if (j.status === 'cancelled') {
                        statusText = "CANCELLED";
                        barColor = '#95a5a6';
                        pct = j.progress || 0;
                    } else if (j.status === 'queued') {
                        statusText = "QUEUED";
                        barColor = '#9b59b6';
                    }

                    // Show cancel button for queued, processing, or uploading jobs
                    if (j.status === 'queued' || j.status === 'processing' || j.status === 'uploading') {
                        actionHtml = `<div class="action-buttons"><button onclick="cancelJob('${j.id}')" class="cancel-btn">‚úï CANCEL</button></div>`;
                    } else if (j.status === 'completed' || j.status === 'failed') {
                        // Parse result_message for error (backward compat)
                        let parts = (j.result_message || "").split("||");
                        let errorMsg = parts[1];
                        
                        // Try to parse JSON from result_message to get error
                        try {
                            const resultData = JSON.parse(j.result_message || "{}");
                            if (resultData.error) {
                                errorMsg = resultData.error;
                            }
                        } catch (e) {
                            // Not JSON, use legacy format
                        }

                        // Get PDF paths from API response (new format) or fallback to legacy
                        let pdfPaths = j.pdf_paths || [];
                        if (pdfPaths.length === 0 && j.pdf_exists !== undefined) {
                            // Backward compat: if pdf_paths not present but pdf_exists is, use legacy parsing
                            let link = parts[0];
                            if (link) {
                                if (!link.startsWith("/")) link = "/" + link;
                                pdfPaths = [{
                                    path: link,
                                    exists: j.pdf_exists !== undefined ? j.pdf_exists : true
                                }];
                            }
                        }

                        let resultHtml = '';
                        // If completed with no error message, upload succeeded - show success message
                        if (j.status === 'completed' && !errorMsg) {
                            resultHtml = `<span style="color:#27ae60; font-size:12px; font-weight:600;">‚úÖ Uploaded to Procore</span>`;
                        } 
                        // If completed with error message, upload failed - show PDF download button(s)
                        else if (j.status === 'completed' && errorMsg) {
                            if (pdfPaths.length > 0) {
                                const downloadLinks = pdfPaths.map(p => {
                                    const link = p.path.startsWith("/") ? p.path : "/" + p.path;
                                    const filename = p.path.split("/").pop() || "PDF";
                                    if (p.exists) {
                                        return `<a href="${link}" target="_blank" class="download-btn" style="background:#f39c12; margin-right:4px;" title="${filename}">‚¨áÔ∏è ${filename}</a>`;
                                    } else {
                                        return `<span class="download-btn disabled" style="margin-right:4px;" title="PDF file has been deleted: ${filename}">‚¨áÔ∏è ${filename}</span>`;
                                    }
                                }).join(" ");
                                resultHtml = downloadLinks + ` <span style="font-size:11px;color:#e74c3c" title="${errorMsg}">‚ö†Ô∏è</span>`;
                            } else {
                                resultHtml = `<span class="download-btn disabled" title="PDF file has been deleted">‚¨áÔ∏è PDF</span> <span style="font-size:11px;color:#e74c3c" title="${errorMsg}">‚ö†Ô∏è</span>`;
                            }
                        }
                        // If failed status, show PDF download button(s) if available
                        else if (j.status === 'failed') {
                            if (pdfPaths.length > 0) {
                                const downloadLinks = pdfPaths.map(p => {
                                    const link = p.path.startsWith("/") ? p.path : "/" + p.path;
                                    const filename = p.path.split("/").pop() || "PDF";
                                    if (p.exists) {
                                        return `<a href="${link}" target="_blank" class="download-btn" style="margin-right:4px;" title="${filename}">‚¨áÔ∏è ${filename}</a>`;
                                    } else {
                                        return `<span class="download-btn disabled" style="margin-right:4px;" title="PDF file has been deleted: ${filename}">‚¨áÔ∏è ${filename}</span>`;
                                    }
                                }).join(" ");
                                resultHtml = downloadLinks;
                            } else {
                                resultHtml = `<span style="color:#e74c3c; font-size:12px;">Failed</span>`;
                            }
                        }
                        actionHtml = `<div class="action-buttons">${resultHtml}<button onclick="deleteJob('${j.id}')" class="delete-btn" title="Delete this job from history">X</button></div>`;
                    } else if (j.status === 'cancelled') {
                        actionHtml = `<div class="action-buttons"><span style="color:#95a5a6; font-size:12px;">Cancelled</span><button onclick="deleteJob('${j.id}')" class="delete-btn" title="Delete this job from history">X</button></div>`;
                    }

                    const tr = document.createElement('tr');
                    const jobDate = new Date(j.created_at + "Z");
                    const dateStr = jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = jobDate.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    
                    // Calculate runtime
                    let runtimeHtml = '';
                    const isOngoing = ['queued', 'processing', 'uploading'].includes(j.status);
                    if (isOngoing) {
                        // For ongoing jobs, show elapsed time (will update via setInterval)
                        const elapsed = calculateElapsedTime(j.created_at);
                        runtimeHtml = `<span style="color:#4CAF50; font-size:12px; font-weight:600;" id="runtime-${j.id}" data-created-at="${j.created_at}">‚è±Ô∏è ${elapsed}</span>`;
                    } else {
                        // For finished jobs, show total run time
                        const endTime = j.updated_at ? new Date(j.updated_at + "Z") : new Date();
                        const startTime = new Date(j.created_at + "Z");
                        const totalSeconds = Math.floor((endTime - startTime) / 1000);
                        const runtime = formatRuntime(totalSeconds);
                        runtimeHtml = `<span style="color:#888; font-size:12px;">${runtime}</span>`;
                    }
                    
                    tr.innerHTML = `
                        <td style="width:15%"><div style="font-size:11px;color:#888;">${dateStr}</div><div style="font-size:12px;">${timeStr}</div></td>
                        <td style="width:22%"><b>${j.project_name || 'Unknown'}</b></td>
                            <td style="width:30%">
                            <span class="progress-text">${statusText} ${pct}%</span>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${pct}%; background-color:${barColor}"></div>
                                </div>
                            </td>
                        <td style="width:18%">${runtimeHtml}</td>
                        <td style="width:15%">${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                    });
                    
                    // Update pagination controls
                    const paginationEl = document.getElementById('history-pagination');
                    const pageInfo = document.getElementById('history-page-info');
                    const prevBtn = document.getElementById('history-prev-btn');
                    const nextBtn = document.getElementById('history-next-btn');
                    
                    if (pagination.total > 6) {
                        paginationEl.style.display = 'flex';
                        pageInfo.textContent = `Page ${pagination.page || 1} of ${pagination.total_pages || 1}`;
                        prevBtn.disabled = !pagination.has_prev;
                        nextBtn.disabled = !pagination.has_next;
                    } else {
                        paginationEl.style.display = 'none';
                    }
                    
                    // Update count
                    const total = pagination.total || 0;
                    const showing = jobs.length;
                    document.getElementById('history-count').textContent = `SHOWING ${showing} OF ${total} RECORDS`;
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error loading recent jobs:', error);
                        const tbody = document.getElementById('jobs-table-body');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#e74c3c;padding:20px;">Error loading jobs. Please refresh the page.</td></tr>';
                        }
                    }
                });
        }

        // Rate Limit Status Functions
        async function updateRateLimitStatus() {
            try {
                const response = await fetch('/api/rate_limit_status');
                if (!response.ok) {
                    // If not authenticated or endpoint not available, hide indicator
                    document.getElementById('rate-limit-indicator').style.display = 'none';
                    return;
                }
                
                const status = await response.json();
                const indicator = document.getElementById('rate-limit-indicator');
                const dot = document.getElementById('rate-limit-dot');
                const text = document.getElementById('rate-limit-text');
                
                // Show indicator if we have rate limit data
                if (status.limit !== null && status.remaining !== null) {
                    indicator.style.display = 'flex';
                    
                    // Update dot color based on remaining percentage
                    const percentage = status.percentage_remaining || 0;
                    dot.className = 'rate-limit-dot';
                    if (percentage < 10) {
                        dot.classList.add('critical');
                    } else if (percentage < 25) {
                        dot.classList.add('warning');
                    }
                    
                    // Update text
                    if (!status.is_available && status.wait_seconds > 0) {
                        const waitMinutes = Math.floor(status.wait_seconds / 60);
                        const waitSeconds = status.wait_seconds % 60;
                        text.className = 'rate-limit-text rate-limit-waiting';
                        text.textContent = `‚è∏Ô∏è Waiting ${waitMinutes}m ${waitSeconds}s`;
                    } else {
                        text.className = 'rate-limit-text';
                        text.textContent = `${status.remaining}/${status.limit} requests`;
                    }
                } else {
                    // No rate limit data yet, hide indicator
                    indicator.style.display = 'none';
                }
            } catch (error) {
                // Silently fail - rate limit status is not critical
                console.debug('Could not fetch rate limit status:', error);
                document.getElementById('rate-limit-indicator').style.display = 'none';
            }
        }

        function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }
            
            authenticatedFetch(`/api/cancel_job/${jobId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.detail || 'Failed to cancel job');
                    });
                }
                return r.json();
            })
            .then(data => {
                console.log('Job cancelled:', data);
                // Reload jobs to show updated status
                loadRecentJobs();
            })
            .catch(err => {
                if (err.message !== 'Authentication failed') {
                    console.error('Error cancelling job:', err);
                    alert('Error cancelling job: ' + err.message);
                }
            });
        }

        function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job from history? This action cannot be undone.')) {
                return;
            }
            
            // Store the job ID for verification
            const jobToDelete = jobId;
            
            authenticatedFetch(`/api/jobs/${jobId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'no-cache'
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.detail || 'Failed to delete job');
                    });
                }
                return r.json();
            })
            .then(data => {
                console.log('Job deleted:', data);
                
                // Wait a moment for the database to commit, then reload with cache busting
                setTimeout(() => {
                    // Force reload with cache busting
                    loadRecentJobs(null, true);
                    
                    // After reload, check if we need to adjust the page
                    setTimeout(() => {
                        authenticatedFetch(`/api/recent_jobs?page=${currentHistoryPage}&per_page=6&_t=${new Date().getTime()}`, {
                            cache: 'no-cache'
                        })
                            .then(r => r.json())
                            .then(pageData => {
                                const jobsOnPage = pageData.jobs || [];
                                const totalAfterDelete = pageData.pagination?.total || 0;
                                
                                // Verify the job was actually deleted
                                const jobStillExists = jobsOnPage.some(j => j.id === jobToDelete);
                                if (jobStillExists) {
                                    console.warn('Job still exists after delete - retrying reload');
                                    // Retry after another moment
                                    setTimeout(() => loadRecentJobs(null, true), 500);
                                }
                                
                                // If current page is now empty and we're not on page 1, go to previous page
                                if (jobsOnPage.length === 0 && currentHistoryPage > 1 && totalAfterDelete > 0) {
                                    currentHistoryPage = currentHistoryPage - 1;
                                    loadRecentJobs(null, true);
                                }
                                updateHistoryCount();
                            })
                            .catch(err => {
                                console.error('Error checking page after delete:', err);
                                updateHistoryCount();
                            });
                    }, 200);
                }, 100);
            })
            .catch(err => {
                if (err.message !== 'Authentication failed') {
                    console.error('Error deleting job:', err);
                    alert('Error deleting job: ' + err.message);
                }
            });
        }

    </script>
</body>

</html>
