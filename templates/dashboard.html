<!DOCTYPE html>
<html>

<head>
    <title>AUTOMATION CONTROL CENTER - VanMar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 0;
        }

        /* HEADER */
        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            height: 100px;
            width: auto;
            /* filter: brightness(0) invert(1); Makes logo white */
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: #e0e0e0;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .rate-limit-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            background: #2a2a2a;
            border-radius: 4px;
            border: 1px solid #3a3a3a;
        }

        .rate-limit-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
        }

        .rate-limit-dot.warning {
            background: #f39c12;
        }

        .rate-limit-dot.critical {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        .rate-limit-text {
            color: #e0e0e0;
        }

        .rate-limit-waiting {
            color: #f39c12;
            font-weight: 600;
        }


        /* MAIN LAYOUT */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        /* JOB MANAGER - LEFT COLUMN */
        .job-manager {
            grid-column: 1;
            grid-row: 1 / 3;
        }

        select,
        input[type="time"] {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            margin-top: 8px;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #27ae60;
        }

        select option {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .label {
            font-weight: 600;
            margin-top: 20px;
            display: block;
            color: #b0b0b0;
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
        }

        .btn-large {
            padding: 15px;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
        }

        #discipline-select {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            min-height: 150px;
        }

        #discipline-select option:checked,
        #discipline-select option[selected] {
            background: #4CAF50 !important;
            color: #fff !important;
            font-weight: 600;
        }

        #drawing-select {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            min-height: 200px;
        }

        #drawing-select option:checked,
        #drawing-select option[selected] {
            background: #4CAF50 !important;
            color: #fff !important;
            font-weight: 600;
        }

        #queue-list {
            list-style: none;
            margin-top: 15px;
        }

        #queue-list li {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #3a3a3a;
        }

        .remove-link {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .remove-link:hover {
            background: #3a1a1a;
        }

        #schedule-options {
            background: #252525;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #3a3a3a;
            display: none;
        }

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ACTIVE AUTOMATIONS - TOP RIGHT */
        .automations-panel {
            grid-column: 2;
            grid-row: 1;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        .automation-card {
            background: #252525;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .automation-time {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .countdown {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }

        .countdown-bar {
            width: 100%;
            height: 6px;
            background: #2a2a2a;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .countdown-fill {
            height: 100%;
            background: #f39c12;
            transition: width 1s;
        }


        /* METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: #252525;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 15px;
        }

        .metric-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-trend {
            font-size: 11px;
            color: #27ae60;
            margin-top: 5px;
        }

        /* SYSTEM CONSOLE */
        .console-panel {
            grid-column: 2;
            grid-row: 2;
            max-height: 300px;
            overflow-y: auto;
        }

        .console {
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 250px;
            overflow-y: auto;
        }

        .console-line {
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
        }

        .console-time {
            color: #666;
        }

        .console-info {
            color: #3498db;
        }

        .console-warn {
            color: #f39c12;
        }

        .console-success {
            color: #27ae60;
        }

        /* JOB HISTORY */
        .history-panel {
            grid-column: 1 / 3;
            grid-row: 3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #252525;
            color: #b0b0b0;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 1px solid #3a3a3a;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #2a2a2a;
            font-size: 13px;
        }

        .progress-container {
            width: 100%;
            background: #2a2a2a;
            border-radius: 4px;
            height: 8px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #27ae60;
            transition: width 0.5s;
        }

        .progress-text {
            font-size: 11px;
            color: #b0b0b0;
            font-weight: 600;
        }

        .download-btn {
            background: #27ae60;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .download-btn:hover {
            background: #229954;
        }

        .download-btn.disabled {
            background: #95a5a6;
            color: #ecf0f1;
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }

        .cancel-btn {
            background: #e74c3c !important;
            color: white !important;
            border: none !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            transition: background 0.2s;
        }

        .cancel-btn:hover {
            background: #c0392b !important;
        }

        .history-footer {
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* FOOTER */
        .footer {
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            padding: 20px 30px;
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: #888;
            text-decoration: none;
        }

        .footer-links a:hover {
            color: #27ae60;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 18px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .job-manager {
                grid-row: 1;
            }
            .automations-panel {
                grid-column: 1;
                grid-row: 2;
            }
            .console-panel {
                grid-column: 1;
                grid-row: 3;
            }
            .history-panel {
                grid-column: 1;
                grid-row: 4;
            }
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <img src="/static/vanmar-logo.png" alt="VanMar Constructors Inc." class="logo-img">
        </div>
        <div class="header-right">
            <div class="header-title">DRAWINGS MERGER APPLICATION</div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span style="font-size: 10px;">OPERATIONAL</span>
            </div>
            <div id="rate-limit-indicator" class="rate-limit-indicator" style="display: none;">
                <div id="rate-limit-dot" class="rate-limit-dot"></div>
                <span id="rate-limit-text" class="rate-limit-text">Loading...</span>
            </div>
            <div>
                <span style="font-size: 10px; color: #888;">Version 1.1.3</span>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-dashboard" class="main-container">
        <!-- JOB MANAGER -->
        <div class="panel job-manager">
            <div class="panel-title">üöÄ JOB MANAGER</div>
            <div class="panel-subtitle">v2.4.0-PRO</div>
            
            <label class="label">1. BUILD YOUR QUEUE</label>
        <select id="project-select" onchange="loadDisciplines()">
                <option value="">-- Select Project --</option>
        </select>
            
        <div id="discipline-section" style="display:none;">
            <label class="label">Select Disciplines <span id="discipline-count" style="color: #888; font-size: 11px; font-weight: normal;">(0 displayed, 0 selected)</span></label>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="selectAllDisciplines()">Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDisciplines()">Deselect All</button>
        </div>
            <select id="discipline-select" multiple size="6" onchange="updateDisciplineCount(); loadDrawings();"></select>
            
            <div id="drawings-section" style="display:none; margin-top: 15px;">
                <label class="label">Select Drawings (or leave empty for all) <span id="drawing-count" style="color: #888; font-size: 11px; font-weight: normal;">(0 displayed, 0 selected)</span></label>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="selectAllDrawings()">Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDrawings()">Deselect All</button>
                </div>
                <select id="drawing-select" multiple size="8" onchange="updateDrawingCount();"></select>
            </div>
            
            <button class="btn btn-primary" onclick="addToQueue()" style="margin-top: 15px;">‚¨áÔ∏è Add to Queue</button>
        </div>
        
            
            <div id="queue-section" style="margin-top: 20px; display:none;">
                <label class="label">2. CURRENT QUEUE</label>
            <ul id="queue-list"></ul>
                
            <div id="schedule-options">
                    <h3 style="margin-bottom: 10px; font-size: 14px;">üìÖ Automation Settings</h3>
                    <p id="tz-display" style="font-size:11px; color:#888; margin-bottom:10px;"></p>
                <div style="display:flex; gap:10px;">
                    <select id="sched-day">
                        <option value="Mon">Monday</option>
                            <option value="Tue">Tuesday</option>
                            <option value="Wed">Wednesday</option>
                            <option value="Thu">Thursday</option>
                        <option value="Fri" selected>Friday</option>
                            <option value="Sat">Saturday</option>
                            <option value="Sun">Sunday</option>
                    </select>
                    <input type="time" id="sched-time" value="17:30">
                </div>
                    <button class="btn btn-primary btn-large" onclick="confirmSchedule()">‚úÖ Save Automation</button>
            </div>
                
            <div class="action-row" id="main-actions">
                    <button class="btn btn-primary" style="flex: 1;" onclick="executeBatch()">‚ñ∫ Run Now</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="showScheduleOpts()">üìÖ Schedule</button>
            </div>
        </div>
    </div>

        <!-- ACTIVE AUTOMATIONS -->
        <div class="panel automations-panel">
            <div class="panel-title">
                üóìÔ∏è ACTIVE AUTOMATIONS
                <span class="live-indicator">
                    <span class="live-dot"></span>
                    <span style="font-size: 11px; color: #e74c3c;">‚Ä¢ LIVE</span>
                </span>
    </div>
            <div id="schedule-list">
                <div style="color:#666; text-align:center; padding:20px;">Loading...</div>
            </div>
        </div>


        <!-- SYSTEM CONSOLE -->
        <div class="panel console-panel">
            <div class="panel-title"><> SYSTEM CONSOLE</div>
            <div class="console" id="console">
                <div class="console-line">
                    <span class="console-time">[14:48:01]</span>
                    <span class="console-info">INFO:</span>
                    <span>Initializing document parsing engine...</span>
                </div>
                <div class="console-line">
                    <span class="console-time">[14:48:05]</span>
                    <span class="console-info">INFO:</span>
                    <span>Connecting to Procore API...</span>
        </div>
    </div>
    </div>

        <!-- RECENT JOB HISTORY -->
        <div class="panel history-panel">
            <div class="panel-title">üïí RECENT JOB HISTORY</div>
        <table>
            <thead>
                <tr>
                        <th>TIME</th>
                        <th>PROJECT</th>
                        <th>PROGRESS</th>
                        <th>RUNTIME</th>
                        <th>RESULT</th>
                </tr>
            </thead>
            <tbody id="jobs-table-body"></tbody>
        </table>
            <div class="history-footer">
                <span id="history-count">SHOWING 0 OF 0 RECORDS</span>
                <div id="history-pagination" style="display: none; margin-top: 10px; justify-content: space-between; align-items: center; gap: 10px;">
                    <button id="history-prev-btn" onclick="changeHistoryPage(-1)" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;" disabled>‚Üê Previous</button>
                    <span id="history-page-info" style="color: #888; font-size: 12px;">Page 1 of 1</span>
                    <button id="history-next-btn" onclick="changeHistoryPage(1)" class="btn btn-secondary" style="padding: 5px 15px; font-size: 12px;" disabled>Next ‚Üí</button>
    </div>
    </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div>INTERNAL USE ONLY ¬© 2024 VANMAR CONSTRUCTORS INC.</div>
    </div>

    <script>
        let jobQueue = [];
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let consoleLines = [];
        let isRedirecting = false;
        let currentHistoryPage = 1;

        // Centralized fetch wrapper that handles authentication failures
        function authenticatedFetch(url, options = {}) {
            return fetch(url, options)
                .then(response => {
                    // Check for authentication failures
                    if (response.status === 401 || response.status === 403) {
                        if (!isRedirecting) {
                            isRedirecting = true;
                            // Show notification
                            addConsoleLog('‚ö†Ô∏è Procore connection lost. Redirecting to login...', 'warn');
                            
                            // Show visual notification overlay
                            const overlay = document.createElement('div');
                            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-size:18px;';
                            overlay.innerHTML = `
                                <div style="text-align:center;padding:30px;background:#1a1a1a;border-radius:8px;border:2px solid #e74c3c;">
                                    <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
                                    <div style="font-weight:600;margin-bottom:10px;">Procore Connection Lost</div>
                                    <div style="font-size:14px;color:#888;">Redirecting to login page...</div>
                                </div>
                            `;
                            document.body.appendChild(overlay);
                            
                            // Redirect after showing message
                            setTimeout(() => {
                                window.location.href = "/login";
                            }, 2000);
                        }
                        // Return a rejected promise to stop further processing
                        return Promise.reject(new Error('Authentication failed'));
                    }
                    return response;
                })
                .catch(error => {
                    // If it's an auth error, don't log it (we're redirecting)
                    if (error.message === 'Authentication failed') {
                        throw error;
                    }
                    // For other errors, log and rethrow
                    console.error('Fetch error:', error);
                    throw error;
                });
        }

        // Initialize
        authenticatedFetch('/api/projects')
            .then(r => r.json())
            .then(data => {
                const sel = document.getElementById('project-select');
                sel.innerHTML = '<option value="">-- Select Project --</option>';
                if (data) data.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            })
            .catch(error => {
                if (error.message !== 'Authentication failed') {
                    console.error('Error loading projects:', error);
                }
            });

        // Initialize: always start on page 1 to show most recent jobs
        currentHistoryPage = 1;
        loadRecentJobs(); 
        loadSchedules();
        
        // Update rate limit status immediately and then every 5 seconds
        updateRateLimitStatus();
        setInterval(updateRateLimitStatus, 5000);
        
        setInterval(() => {
            // Always check current page for jobs
            loadRecentJobs();
        }, 2000);
        
        // Update running job times every second
        setInterval(() => {
            const tbody = document.getElementById('jobs-table-body');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const runtimeEl = row.querySelector('[id^="runtime-"]');
                if (runtimeEl) {
                    const createdAt = runtimeEl.getAttribute('data-created-at');
                    if (createdAt) {
                        const elapsed = calculateElapsedTime(createdAt);
                        runtimeEl.innerHTML = `‚è±Ô∏è ${elapsed}`;
                    }
                }
            });
        }, 1000);

        function addConsoleLog(message, type = 'info') {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `
                <span class="console-time">[${timeStr}]</span>
                <span class="console-${type}">${type.toUpperCase()}:</span>
                <span>${message}</span>
            `;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
            consoleLines.push({ time: timeStr, type, message });
            if (consoleLines.length > 50) {
                consoleLines.shift();
                console.removeChild(console.firstChild);
            }
        }

        function updateHistoryCount() {
            authenticatedFetch(`/api/recent_jobs?page=${currentHistoryPage}&per_page=6`)
                .then(r => r.json())
                .then(data => {
                    const jobs = data.jobs || [];
                    const pagination = data.pagination || {};
                    const total = pagination.total || 0;
                    const showing = jobs.length;
                    const start = showing > 0 ? (currentHistoryPage - 1) * 6 + 1 : 0;
                    const end = start + showing - 1;
                    
                    document.getElementById('history-count').textContent = `SHOWING ${showing} OF ${total} RECORDS`;
                    
                    // Update pagination controls
                    const paginationEl = document.getElementById('history-pagination');
                    const pageInfo = document.getElementById('history-page-info');
                    const prevBtn = document.getElementById('history-prev-btn');
                    const nextBtn = document.getElementById('history-next-btn');
                    
                    if (total > 6) {
                        paginationEl.style.display = 'flex';
                        pageInfo.textContent = `Page ${pagination.page || 1} of ${pagination.total_pages || 1}`;
                        prevBtn.disabled = !pagination.has_prev;
                        nextBtn.disabled = !pagination.has_next;
                    } else {
                        paginationEl.style.display = 'none';
                    }
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error updating history count:', error);
                    }
                });
        }
        
        function changeHistoryPage(delta) {
            const newPage = currentHistoryPage + delta;
            if (newPage < 1) return;
            
            currentHistoryPage = newPage;
            loadRecentJobs();
            updateHistoryCount();
        }
        
        function calculateElapsedTime(createdAt) {
            const start = new Date(createdAt + "Z");
            const now = new Date();
            const seconds = Math.floor((now - start) / 1000);
            return formatRuntime(seconds);
        }
        
        function formatRuntime(totalSeconds) {
            if (totalSeconds < 60) {
                return `${totalSeconds}s`;
            } else if (totalSeconds < 3600) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return seconds > 0 ? `${minutes}m ${seconds}s` : `${minutes}m`;
            } else {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (minutes > 0 && seconds > 0) {
                    return `${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${hours}h ${seconds}s`;
                }
            }
        }
        

        function updateDisciplineCount() {
            const sel = document.getElementById('discipline-select');
            const countEl = document.getElementById('discipline-count');
            if (!sel || !countEl) return;
            
            const total = Array.from(sel.options).filter(opt => !opt.disabled).length;
            const selected = Array.from(sel.selectedOptions).length;
            countEl.textContent = `(${total} displayed, ${selected} selected)`;
        }

        function selectAllDisciplines() {
            const sel = document.getElementById('discipline-select');
            if (!sel || sel.disabled) return;
            
            // Select all non-disabled options
            Array.from(sel.options).forEach(opt => {
                if (!opt.disabled && opt.value !== '') {
                    opt.selected = true;
                }
            });
            
            // Force browser to repaint by focusing and blurring
            sel.focus();
            setTimeout(() => {
                sel.blur();
                // Trigger change event to update counts and load drawings
                sel.dispatchEvent(new Event('change'));
            }, 10);
        }

        function deselectAllDisciplines() {
            const sel = document.getElementById('discipline-select');
            if (!sel || sel.disabled) return;
            
            Array.from(sel.options).forEach(opt => opt.selected = false);
            
            // Trigger change event to update counts
            sel.dispatchEvent(new Event('change'));
        }

        function loadDisciplines() {
            const pid = document.getElementById('project-select').value;
            if (!pid) {
                document.getElementById('discipline-section').style.display = 'none';
                document.getElementById('drawings-section').style.display = 'none';
                return;
            }
            document.getElementById('discipline-section').style.display = 'block';
            document.getElementById('drawings-section').style.display = 'none';
                const sel = document.getElementById('discipline-select');
            sel.innerHTML = '<option disabled style="color: #666; text-align: center;">‚è≥ Loading disciplines...</option>';
            sel.disabled = true;
            
            authenticatedFetch(`/api/disciplines?project_id=${pid}`)
                .then(r => {
                    if (!r.ok) throw new Error('Failed to load disciplines');
                    return r.json();
                })
                .then(data => {
                    sel.disabled = false;
                sel.innerHTML = '';
                    if (data.disciplines && data.disciplines.length > 0) {
                        // Check if disciplines is array of objects (with counts) or strings (legacy)
                        const isObjectFormat = typeof data.disciplines[0] === 'object';
                        if (isObjectFormat) {
                            data.disciplines.forEach(d => {
                                const name = d.name || d;
                                const count = d.count || 0;
                                sel.innerHTML += `<option value="${name}">${name} (${count} drawing${count !== 1 ? 's' : ''})</option>`;
                            });
                            const totalDrawings = data.disciplines.reduce((sum, d) => sum + (d.count || 0), 0);
                            addConsoleLog(`Loaded ${data.disciplines.length} disciplines with ${totalDrawings} total drawings`, 'info');
                        } else {
                            // Legacy format - just strings
                            data.disciplines.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
                            addConsoleLog(`Loaded ${data.disciplines.length} disciplines`, 'info');
                        }
                        updateDisciplineCount();
                    } else {
                        sel.innerHTML = '<option disabled style="color: #666;">No disciplines found</option>';
                        updateDisciplineCount();
                    }
                })
                .catch(error => {
                    if (error.message === 'Authentication failed') {
                        return; // Don't show error, redirecting
                    }
                    sel.disabled = false;
                    sel.innerHTML = '<option disabled style="color: #e74c3c;">‚ùå Error loading disciplines</option>';
                    addConsoleLog('Failed to load disciplines', 'warn');
                });
        }

        function loadDrawings() {
            const pid = document.getElementById('project-select').value;
            const dSel = document.getElementById('discipline-select');
            const selectedDisciplines = Array.from(dSel.selectedOptions).map(o => o.value);
            
            if (!pid || selectedDisciplines.length === 0) {
                document.getElementById('drawings-section').style.display = 'none';
                return;
            }
            
            // Show drawings section
            document.getElementById('drawings-section').style.display = 'block';
            const drawingSel = document.getElementById('drawing-select');
            drawingSel.innerHTML = '<option disabled style="color: #666;">‚è≥ Loading drawings...</option>';
            drawingSel.disabled = true;
            
            // Load drawings for all selected disciplines
            const allDrawings = [];
            const loadPromises = selectedDisciplines.map(discipline => 
                authenticatedFetch(`/api/drawings?project_id=${pid}&discipline=${encodeURIComponent(discipline)}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`Failed to load drawings for ${discipline}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data.drawings) {
                            data.drawings.forEach(d => {
                                d.discipline = discipline; // Tag with discipline
                                allDrawings.push(d);
                            });
                        }
                    })
            );
            
            Promise.all(loadPromises)
                .then(() => {
                    drawingSel.disabled = false;
                    drawingSel.innerHTML = '';
                    
                    if (allDrawings.length > 0) {
                        // Sort by drawing number
                        allDrawings.sort((a, b) => {
                            const numA = a.number || '';
                            const numB = b.number || '';
                            return numA.localeCompare(numB, undefined, { numeric: true, sensitivity: 'base' });
                        });
                        
                        // Populate main drawing select
                        allDrawings.forEach(d => {
                            const rev = d.revision ? ` Rev.${d.revision}` : '';
                            const optionText = `${d.number}${rev} - ${d.title || ''} (${d.discipline})`;
                            drawingSel.innerHTML += `<option value="${d.id}" data-number="${d.number}" data-discipline="${d.discipline}">${optionText}</option>`;
                        });
                        
                        addConsoleLog(`Loaded ${allDrawings.length} drawings from ${selectedDisciplines.length} discipline(s)`, 'info');
                        updateDrawingCount();
                    } else {
                        drawingSel.innerHTML = '<option disabled style="color: #666;">No drawings found</option>';
                        updateDrawingCount();
                    }
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        drawingSel.disabled = false;
                        drawingSel.innerHTML = '<option disabled style="color: #e74c3c;">‚ùå Error loading drawings</option>';
                        addConsoleLog('Failed to load drawings', 'warn');
                        updateDrawingCount();
                    }
                });
        }

        function updateDrawingCount() {
            const sel = document.getElementById('drawing-select');
            const countEl = document.getElementById('drawing-count');
            if (!sel || !countEl) return;
            
            const total = Array.from(sel.options).filter(opt => !opt.disabled).length;
            const selected = Array.from(sel.selectedOptions).length;
            countEl.textContent = `(${total} displayed, ${selected} selected)`;
        }

        function selectAllDrawings() {
            const sel = document.getElementById('drawing-select');
            if (!sel || sel.disabled) return;
            
            // Select all non-disabled options
            Array.from(sel.options).forEach(opt => {
                if (!opt.disabled && opt.value !== '') {
                    opt.selected = true;
                }
            });
            
            // Force browser to repaint by focusing and blurring
            sel.focus();
            setTimeout(() => {
                sel.blur();
                // Trigger change event to update counts
                sel.dispatchEvent(new Event('change'));
            }, 10);
        }

        function deselectAllDrawings() {
            const sel = document.getElementById('drawing-select');
            if (!sel || sel.disabled) return;
            
            Array.from(sel.options).forEach(opt => opt.selected = false);
            
            // Trigger change event to update counts
            sel.dispatchEvent(new Event('change'));
        }

        function addToQueue() {
            const pSel = document.getElementById('project-select');
            const dSel = document.getElementById('discipline-select');
            const drawingSel = document.getElementById('drawing-select');
            const discs = Array.from(dSel.selectedOptions).map(o => o.value);
            const selectedDrawings = Array.from(drawingSel.selectedOptions).map(o => o.value);
            
            if (discs.length === 0) {
                addConsoleLog('No disciplines selected', 'warn');
                return;
            }
            
            const jobData = { 
                project_id: parseInt(pSel.value), 
                project_name: pSel.options[pSel.selectedIndex].text, 
                disciplines: discs
            };
            
            // If specific drawings are selected, include them; otherwise process all drawings in disciplines
            if (selectedDrawings.length > 0) {
                jobData.drawing_ids = selectedDrawings.map(id => parseInt(id)); // Convert to integers
                addConsoleLog(`Added ${pSel.options[pSel.selectedIndex].text} with ${selectedDrawings.length} selected drawing(s) to queue`, 'success');
            } else {
                addConsoleLog(`Added ${pSel.options[pSel.selectedIndex].text} with all drawings from selected disciplines to queue`, 'success');
            }
            
            jobQueue.push(jobData);
            renderQueue();
            pSel.value = ""; 
            dSel.innerHTML = ""; 
            drawingSel.innerHTML = "";
            document.getElementById('discipline-section').style.display = 'none';
            document.getElementById('drawings-section').style.display = 'none';
        }

        function renderQueue() {
            const list = document.getElementById('queue-list');
            document.getElementById('queue-section').style.display = jobQueue.length ? 'block' : 'none';
            list.innerHTML = '';
            jobQueue.forEach((j, i) => {
                const li = document.createElement('li');
                let desc = `<b>${j.project_name}</b> - ${j.disciplines.join(', ')}`;
                if (j.drawing_ids && j.drawing_ids.length > 0) {
                    desc += ` (${j.drawing_ids.length} selected drawing${j.drawing_ids.length !== 1 ? 's' : ''})`;
                }
                li.innerHTML = `<span>${desc}</span> <span class="remove-link" onclick="jobQueue.splice(${i},1);renderQueue()">DELETE</span>`;
                list.appendChild(li);
            });
        }

        function executeBatch() {
            if (jobQueue.length === 0) {
                addConsoleLog('Queue is empty', 'warn');
                return;
            }
            addConsoleLog(`Starting batch job with ${jobQueue.length} project(s)`, 'info');
            authenticatedFetch('/api/start_job', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ queue: jobQueue }) 
            })
            .then(r => r.json())
            .then(() => { 
                jobQueue = []; 
                renderQueue(); 
                addConsoleLog('Batch job initiated successfully', 'success');
            })
            .catch(err => {
                if (err.message !== 'Authentication failed') {
                    addConsoleLog('Failed to start batch job', 'warn');
                }
            });
        }

        function showScheduleOpts() {
            if (jobQueue.length === 0) {
                addConsoleLog('Build queue first before scheduling', 'warn');
                return;
            }
            document.getElementById('schedule-options').style.display = 'block';
            document.getElementById('main-actions').style.display = 'none';
            document.getElementById('tz-display').innerText = `Detected Timezone: ${userTimezone}`;
        }

        function confirmSchedule() {
            const day = document.getElementById('sched-day').value;
            const time = document.getElementById('sched-time').value;
            authenticatedFetch('/api/schedule_batch', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queue: jobQueue, day: day, time: time, timezone: userTimezone })
            })
            .then(r => r.json())
            .then(() => {
                addConsoleLog(`Scheduled automation for ${day} ${time}`, 'success');
                jobQueue = []; 
                renderQueue(); 
                document.getElementById('schedule-options').style.display = 'none'; 
                document.getElementById('main-actions').style.display = 'flex'; 
                loadSchedules();
            })
            .catch(err => {
                if (err.message !== 'Authentication failed') {
                    addConsoleLog('Failed to create schedule', 'warn');
                }
            });
        }

        function loadSchedules() {
            authenticatedFetch('/api/schedules')
                .then(r => r.json())
                .then(data => {
                const list = document.getElementById('schedule-list');
                list.innerHTML = '';
                    if (!data.length) {
                        list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No active schedules.</div>';
                        return;
                    }
                data.forEach(s => {
                    const discs = JSON.parse(s.disciplines_json);
                    const timeStr = `${s.day_of_week} ${s.hour.toString().padStart(2, '0')}:${s.minute.toString().padStart(2, '0')}`;
                    const card = document.createElement('div');
                    card.className = 'automation-card';
                    
                    // Calculate next run time
                    const now = new Date();
                    const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const nextRun = calculateNextRun(s.day_of_week, s.hour, s.minute, s.timezone);
                    const timeUntil = getTimeUntil(nextRun);
                    
                    card.innerHTML = `
                        <div class="automation-time">
                            <span>üïê</span>
                            <span><b>${timeStr}</b> (${s.timezone})</span>
                        </div>
                        <div style="margin-bottom: 8px; font-size: 13px;">Project: <b>${s.project_name}</b></div>
                        <div class="countdown">
                            NEXT RUN IN: <span id="countdown-${s.id}">${timeUntil}</span> <span style="font-size: 10px; color: #666;">(DD:HH:MM:SS)</span>
                            <div class="countdown-bar">
                                <div class="countdown-fill" id="bar-${s.id}" style="width: 0%"></div>
                            </div>
                        </div>
                        <button class="remove-link" onclick="deleteSchedule('${s.id}')" style="margin-top: 10px; display: block;">DELETE</button>
                    `;
                    list.appendChild(card);
                    
                    // Update countdown
                    updateCountdown(s.id, nextRun);
                });
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error loading schedules:', error);
                    }
                });
        }

        function calculateNextRun(dayOfWeek, hour, minute, timezone) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const currentDay = days[today.getDay() === 0 ? 6 : today.getDay() - 1];
            const targetDayIndex = days.indexOf(dayOfWeek);
            const currentDayIndex = days.indexOf(currentDay);
            
            let daysUntil = targetDayIndex - currentDayIndex;
            if (daysUntil < 0) daysUntil += 7;
            if (daysUntil === 0) {
                const now = new Date();
                const targetTime = new Date(now);
                targetTime.setHours(hour, minute, 0, 0);
                if (targetTime <= now) daysUntil = 7;
            }
            
            const nextRun = new Date();
            nextRun.setDate(nextRun.getDate() + daysUntil);
            nextRun.setHours(hour, minute, 0, 0);
            return nextRun;
        }

        function getTimeUntil(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            if (diff < 0) return '00:00:00:00';
            const days = Math.floor(diff / (24 * 3600000));
            const hours = Math.floor((diff % (24 * 3600000)) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateCountdown(scheduleId, targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            const totalDay = 7 * 24 * 60 * 60 * 1000;
            const percent = Math.max(0, Math.min(100, 100 - (diff / totalDay * 100)));
            
            const countdownEl = document.getElementById(`countdown-${scheduleId}`);
            const barEl = document.getElementById(`bar-${scheduleId}`);
            if (countdownEl) countdownEl.textContent = getTimeUntil(targetDate);
            if (barEl) barEl.style.width = `${percent}%`;
        }

        setInterval(() => {
            authenticatedFetch('/api/schedules')
                .then(r => r.json())
                .then(data => {
                    data.forEach(s => {
                        const nextRun = calculateNextRun(s.day_of_week, s.hour, s.minute, s.timezone);
                        updateCountdown(s.id, nextRun);
                    });
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error updating countdown:', error);
                    }
                });
        }, 1000);

        function deleteSchedule(id) {
            if (confirm("Stop this automation?")) {
                authenticatedFetch(`/api/schedule/${id}`, { method: 'DELETE' })
                    .then(() => {
                        loadSchedules();
                        addConsoleLog('Automation deleted', 'info');
                    })
                    .catch(error => {
                        if (error.message !== 'Authentication failed') {
                            addConsoleLog('Failed to delete automation', 'warn');
                        }
                    });
            }
        }

        function loadRecentJobs(forcePage = null) {
            const pageToLoad = forcePage !== null ? forcePage : currentHistoryPage;
            authenticatedFetch(`/api/recent_jobs?page=${pageToLoad}&per_page=6`)
                .then(r => r.json())
                .then(data => {
                    const jobs = data.jobs || [];
                    const pagination = data.pagination || {};
                    
                    // Check if there are any active jobs (queued, processing, uploading) on page 1
                    // If user is on a different page and there are active jobs, suggest going to page 1
                    // But don't force it - let user navigate freely
                    const hasActiveJobsOnPage1 = pageToLoad === 1 && jobs.some(j => ['queued', 'processing', 'uploading'].includes(j.status));
                    
                    // Update current page if we forced a page change
                    if (forcePage !== null) {
                        currentHistoryPage = forcePage;
                    }
                    
                const tbody = document.getElementById('jobs-table-body');
                tbody.innerHTML = '';
                    
                    if (jobs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888;padding:20px;">No jobs found</td></tr>';
                    }
                    
                jobs.forEach(j => {
                    let actionHtml = '-';
                    let pct = j.progress || 0;
                    let barColor = '#3498db';
                    let statusText = j.status.toUpperCase();

                    // Build progress text with drawing counts if available
                    let progressDetails = '';
                    if (j.total_drawings && j.total_drawings > 0) {
                        const processed = j.processed_drawings || 0;
                        const remaining = Math.max(0, j.total_drawings - processed);
                        progressDetails = ` (${processed}/${j.total_drawings} drawings)`;
                    }
                    
                    if (j.status === 'processing') { 
                        statusText = `GENERATING ${pct}%${progressDetails}`; 
                    } else if (j.status === 'uploading') { 
                        statusText = "UPLOADING..."; 
                        barColor = '#f39c12'; 
                    } else if (j.status === 'completed') { 
                        statusText = "SUCCESS"; 
                        barColor = '#27ae60'; 
                        pct = 100; 
                    } else if (j.status === 'failed') { 
                        statusText = "FAILED"; 
                        barColor = '#e74c3c'; 
                        pct = 100; 
                    } else if (j.status === 'cancelled') {
                        statusText = "CANCELLED";
                        barColor = '#95a5a6';
                        pct = j.progress || 0;
                    } else if (j.status === 'queued') {
                        statusText = "QUEUED";
                        barColor = '#9b59b6';
                    }

                    // Show cancel button for queued, processing, or uploading jobs
                    if (j.status === 'queued' || j.status === 'processing' || j.status === 'uploading') {
                        actionHtml = `<button onclick="cancelJob('${j.id}')" class="cancel-btn">‚úï CANCEL</button>`;
                    } else if (j.status === 'completed' || j.status === 'failed') {
                        let parts = (j.result_message || "").split("||");
                        let link = parts[0]; 
                        let errorMsg = parts[1];
                        if (link && !link.startsWith("/")) link = "/" + link;

                        // Check if PDF exists
                        const pdfExists = j.pdf_exists !== undefined ? j.pdf_exists : true; // Default to true for backward compatibility
                        const disabledClass = pdfExists ? "" : " disabled";
                        const disabledAttr = pdfExists ? "" : ' onclick="return false;"';

                        if (j.status === 'completed' && !errorMsg) {
                            if (pdfExists) {
                                actionHtml = `<a href="${link}" target="_blank" class="download-btn">‚¨áÔ∏è PDF</a>`;
                            } else {
                                actionHtml = `<span class="download-btn disabled" title="PDF file has been deleted">‚¨áÔ∏è PDF</span>`;
                            }
                        } else if (link) {
                            if (pdfExists) {
                                actionHtml = `<a href="${link}" target="_blank" class="download-btn" style="background:#f39c12">‚¨áÔ∏è PDF</a> <span style="font-size:11px;color:#e74c3c" title="${errorMsg}">‚ö†Ô∏è</span>`;
                        } else {
                                actionHtml = `<span class="download-btn disabled" title="PDF file has been deleted">‚¨áÔ∏è PDF</span> <span style="font-size:11px;color:#e74c3c" title="${errorMsg}">‚ö†Ô∏è</span>`;
                            }
                        } else {
                            actionHtml = `<span style="color:#e74c3c">Failed</span>`;
                        }
                    } else if (j.status === 'cancelled') {
                        actionHtml = `<span style="color:#95a5a6; font-size:12px;">Cancelled</span>`;
                    }

                    const tr = document.createElement('tr');
                    const jobDate = new Date(j.created_at + "Z");
                    const dateStr = jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = jobDate.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    
                    // Calculate runtime
                    let runtimeHtml = '';
                    const isOngoing = ['queued', 'processing', 'uploading'].includes(j.status);
                    if (isOngoing) {
                        // For ongoing jobs, show elapsed time (will update via setInterval)
                        const elapsed = calculateElapsedTime(j.created_at);
                        runtimeHtml = `<span style="color:#4CAF50; font-size:12px; font-weight:600;" id="runtime-${j.id}" data-created-at="${j.created_at}">‚è±Ô∏è ${elapsed}</span>`;
                    } else {
                        // For finished jobs, show total run time
                        const endTime = j.updated_at ? new Date(j.updated_at + "Z") : new Date();
                        const startTime = new Date(j.created_at + "Z");
                        const totalSeconds = Math.floor((endTime - startTime) / 1000);
                        const runtime = formatRuntime(totalSeconds);
                        runtimeHtml = `<span style="color:#888; font-size:12px;">${runtime}</span>`;
                    }
                    
                    tr.innerHTML = `
                        <td style="width:15%"><div style="font-size:11px;color:#888;">${dateStr}</div><div style="font-size:12px;">${timeStr}</div></td>
                        <td style="width:22%"><b>${j.project_name || 'Unknown'}</b></td>
                            <td style="width:30%">
                            <span class="progress-text">${statusText} ${pct}%</span>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${pct}%; background-color:${barColor}"></div>
                                </div>
                            </td>
                        <td style="width:18%">${runtimeHtml}</td>
                        <td style="width:15%">${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                    });
                    
                    // Update pagination controls
                    const paginationEl = document.getElementById('history-pagination');
                    const pageInfo = document.getElementById('history-page-info');
                    const prevBtn = document.getElementById('history-prev-btn');
                    const nextBtn = document.getElementById('history-next-btn');
                    
                    if (pagination.total > 6) {
                        paginationEl.style.display = 'flex';
                        pageInfo.textContent = `Page ${pagination.page || 1} of ${pagination.total_pages || 1}`;
                        prevBtn.disabled = !pagination.has_prev;
                        nextBtn.disabled = !pagination.has_next;
                    } else {
                        paginationEl.style.display = 'none';
                    }
                    
                    // Update count
                    const total = pagination.total || 0;
                    const showing = jobs.length;
                    document.getElementById('history-count').textContent = `SHOWING ${showing} OF ${total} RECORDS`;
                })
                .catch(error => {
                    if (error.message !== 'Authentication failed') {
                        console.error('Error loading recent jobs:', error);
                        const tbody = document.getElementById('jobs-table-body');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#e74c3c;padding:20px;">Error loading jobs. Please refresh the page.</td></tr>';
                        }
                    }
                });
        }

        // Rate Limit Status Functions
        async function updateRateLimitStatus() {
            try {
                const response = await fetch('/api/rate_limit_status');
                if (!response.ok) {
                    // If not authenticated or endpoint not available, hide indicator
                    document.getElementById('rate-limit-indicator').style.display = 'none';
                    return;
                }
                
                const status = await response.json();
                const indicator = document.getElementById('rate-limit-indicator');
                const dot = document.getElementById('rate-limit-dot');
                const text = document.getElementById('rate-limit-text');
                
                // Show indicator if we have rate limit data
                if (status.limit !== null && status.remaining !== null) {
                    indicator.style.display = 'flex';
                    
                    // Update dot color based on remaining percentage
                    const percentage = status.percentage_remaining || 0;
                    dot.className = 'rate-limit-dot';
                    if (percentage < 10) {
                        dot.classList.add('critical');
                    } else if (percentage < 25) {
                        dot.classList.add('warning');
                    }
                    
                    // Update text
                    if (!status.is_available && status.wait_seconds > 0) {
                        const waitMinutes = Math.floor(status.wait_seconds / 60);
                        const waitSeconds = status.wait_seconds % 60;
                        text.className = 'rate-limit-text rate-limit-waiting';
                        text.textContent = `‚è∏Ô∏è Waiting ${waitMinutes}m ${waitSeconds}s`;
                    } else {
                        text.className = 'rate-limit-text';
                        text.textContent = `${status.remaining}/${status.limit} requests`;
                    }
                } else {
                    // No rate limit data yet, hide indicator
                    indicator.style.display = 'none';
                }
            } catch (error) {
                // Silently fail - rate limit status is not critical
                console.debug('Could not fetch rate limit status:', error);
                document.getElementById('rate-limit-indicator').style.display = 'none';
            }
        }

        function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }
            
            authenticatedFetch(`/api/cancel_job/${jobId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.detail || 'Failed to cancel job');
                    });
                }
                return r.json();
            })
            .then(data => {
                console.log('Job cancelled:', data);
                addConsoleLog(`Job ${jobId} cancelled`, 'warning');
                // Reload jobs to show updated status
                loadRecentJobs();
            })
            .catch(err => {
                if (err.message !== 'Authentication failed') {
                    console.error('Error cancelling job:', err);
                    alert('Error cancelling job: ' + err.message);
                }
            });
        }

        // Initial console messages
        addConsoleLog('System initialized', 'success');
        addConsoleLog('Ready for automation tasks', 'info');
    </script>
</body>

</html>
